# ATmega128

### ATmega128의 특징

- 고성능의 저전력 8비트 마이크로컨트롤러
    - Atmel사에서 출시하는 AVR 시리즈
- 진보된 RISC 구조
    - 133개의 강력한 명령어 : 대부분 1 클록 사이클에서 실행
    - 단일 클럭 내에서 하나의 명령어를 실행(1MHz당 1MIPS의 성능)
    - 32개의 레지스터
        - ALU에 직접 연결
        - 1클럭 사이클 내에 하나의 명령어로 두 개의 레지스터를 액세스
        - CISC 마이크로컨트롤러에 비해 약 10배 정도 효율
    - 처리 성능 : 16[MHz] ~ 16[MIPS]
    - 2클록 사이클이 소요되는 곱셈기를 칩에 내장
- 비휘발성 프로그램과 데이터 메모리
    - ISP 방식의 플래시 메모리 내장: 10,000회 읽기/쓰기 가능
    - 4[KByte]의 EEPROM: 100,000회까지 읽기/쓰기 가능
    - 4[KByte]의 SRAM 내장
    - 외부 추가 사용 가능 메모리 공간: 64[KByte]까지
    - SPI 인터페이스를 이용한 ISP(In System Programming)
- 입출력 포트 핀은 프로세서가 리셋되면 Tri-State를 유지한다.
- 주변 장치
    - 7개의 I/O 포트
        - 8비트의 I/O 포트 - A, B, C, D, E, F
        - 5비트의 I/O 포트 - G
    - 2개의 8비트 타이머/카운터
        - 별도의 프리스케일러와 비교 모드 동작
    - 2개의 16비트 타이머/카운터
        - 별도의 프로스케일러, 비교 모드, 캡쳐 모드 동작
    - 발진 회로와 분리된 실시간 타이머 카운터
    - 6개의 PWM 채널: 2~16비트까지 조정 가능
    - 출력 비교 모듈레이터
    - 2개의 USART
    - 아날로그 비교기
    - 8채널의 10비트 A/D 변환기(ADC: Analog to Digital Converter)
        - 8개의 단극성 입력 채널: 그라운드(GND) 신호와 입력 신호(Vi) 사이의 전위차
        - 7개의 차동 입력 채널: 두 입력 신호의 전위차(Vp-Vn)
        - 2개의 프로그램 가능한 입력 이득(1x, 10x, 200x)을 갖는 채널
    - 2선식 직렬 인터페이스(TWI : Two-wire Serial Interface): 바이트 지향
    - 2개의 USART : RS232통신, RS485통신 등에 적용
    - Master/Slave SPI 직렬 인터페이스
    - 프로그램 가능한 와치독 타이머 : 내부 발진 회로와 연결

### ATmega128의 내장 기능

- JTAG(IEEE std. 1149.1 호환) 인터페이스
    - JTAG 표준에 따른 Boundary-scan 수용
    - 온-칩 디버깅 지원
    - JTAG 인터페이스를 통해 플래쉬, EEPROM, 휴즈, 락비트 프로그래밍 가능
- 특수 기능
    - 파워온 리셋 : 외부 별도 리셋 회로 없이 전원 인가(레지스터 초기화)
    - 브라운아웃 전압 검출 : 2.7V 또는 4.3V 이하의 전원 전압 검출
    - 프로그램으로 조율이 가능한 내부 RC 발진 회로
    - 6개의 휴먼 모드
        - Idle, A/D 변환기 잡음 제거, 파워-세이브, 파워-다운, 대기(Standby), 확장 대기(Extended Standby)
    - 소프트웨어적으로 선택 가능한 클럭 주파수
    - 휴즈 비트로 ATmega103 호환 모드 선택
    - 전체 풀업(Pull up) 저항 해제
    

### ATmega128의 내부 구조

1. 주요 구성 요소
    1. 8-bit ALU
    2. 내장 메모리 : 플래시 메모리, SRAM, EEPROM
        1. 플래시 프로그램 메모리
            1. 특징: 비활성 메모리
            2. 용량: 128[Kbyte]
            3. 10,000번의 쓰기, 지우기 반복 가능
        2. 데이터메모리(SRAM)
            1. 특징 : 프로그램에 선언한 변수와 스택을 위해 읽고 쓰기를 빠르게 수행할 수 있는 주메모리(휘발성 메모리)
            2. 용량: 4[Kbyte]
        3. EEPROM
            1. 특징: 프로그램 실행 중 생성된 데이터 전원 없이도 유지, SRAM, 플래시 프로그램 메모리보다 시간이 오래 걸림
            2. 용량: 4[Kbyte]
    3. 입출력 장치
    4. 기타
        1. 패키지: 64핀
        2. 동작 주파수: ~ 16MHz
        3. 동작 환경: -40도~85도
        4. 전원 전압: 2.7~5.5V
    5. On-Chip 입출력 장치
        1. GPIO(General purpose I/O)
            1. 범용 입출력 포트로 53개의 프로그램 가능
                1. 6개의 8비트 포트 - A, B, C, D, E, F
                2. 1개의 5비트의 포트 - G
        2. 타이머
            1. 8비트 2개, 16비트 2개의 8비트 타이머
            2. 실시간 클럭(RTC: Reat Time Clock) 구성 가능
        3. 와치독(watchdog) 타이머
            1. 타임아웃 주기를 프로그램 가능
            2. 별도 내부 발진기 사용
        4. PWM(Plus Width Modulation)
            1. 입력 값에 따라 펄스 폭 변조
            2. 2채널의 8비트, 6채널의 PWM
        5. 아날로그 인터페이스
            1. 8채널의 10비트 ADC
            2. 아날로그 비교기
        6. USART
            1. 범용 동기/비동기 시리얼 포트
            2. 2포트
        7. SPI(serial peripheral interface)
            1. 전이중 동기 시리얼 인터페이스
            2. 플래시 메모리 프로그램에 사용
            3. 3선(MISO, MOSI, SCK) 사용
            4. 최대 전송 속도: (시스템 클럭 주파수)/4
        8. TWI(Two-wire serial Interface)
            1. 동기 시리얼 인터페이스
            2. 필립스의 I^2C(Inter-IC)와 동일
            3. 2선(SDA, SCL) 사용
            4. 전송속도: 400KHz
        9. JTAG 인터페이스
            1. 플래시 메모리 프로그래밍(ISP)
            2. 디버깅
            3. 칩 테스트
        10. 프로그램 카운터(PC)
            1. 플래시 프로그램 메모리 공간을 가리킴
            2. 명령어를 차례로 인출하면서 응용프로그램 실행
        11. 명령 레지스터(IR)
            1. 프로그램 카운터가 지칭한 곳에서 명령어 레지스터로 명령어 인출
            2. 명령어에는 명령 코드, 오퍼랜드, 연산 결과 저장 위치 필드를 가짐
        12. 명령어 디코더
            1. 명령어 레지스터의 명령코드를 디코딩해 제어 신호 생성
            2. ALU는 명령 코드에 해당되는 연산동작을 수행하게 함
            3. 제어 신호는 연산 대상이 되는 오퍼랜드가 ALU에 전달되게 함
            4. 제어 신호는 연산 결과를 저장할 수 있게 함
        13. 스택 포인터
            1. 스택은 임시 데이터, 로컬 변수, 호출된 함수의 복귀 주소 등을 저장
            2. 스택 포인터는 스택의 TOP을 저장하는 특수 레지스터
            3. 스택에 데이터가 저장되면, 스택 공간은 커짐
            4. 스택 포인터의 주소는 높은 값에서 낮은 값으로 감소
            5. PUSH 명령어 - 데이터가 스택에 저장(스택 포인터는 1씩 증가)
            6. POP 명령어 - 데이터를 스택의 TOP에서 꺼냄(스택 포인터는 1씩 감소)

** 마이크로 프로세서와 마이크로 컨트롤러 차이

### ATmega128의 동작 환경

- 동작 주파수
    - ATmega128A: ~16MHz
    - ATmega128: ~16MHz
    - ATmega128L: ~8MHz
- 공급 전원
    - ATmega128A: 2.7~5.5V
    - ATmega128: 4.5~5.5V
    - ATmega128L: 2.7~5.5V
- 동작 온도
    - 상용: 0~70도
    - 산업용: -40도~ 85도
- ATmega128의 패키지
    - 64-lead TQFP(Thin Quad Flat package)
    - 64-pad MLF(Micro Lead Frame)
- ATmega128의 핀
    - 64개의 핀으로 구성
    - 패키지는 TQFP, MLF
    - 기본 용도: 입출력 포트용
    - 대체 용도: 프로세서에 내장된 입출력 장치의 신호선

### 핀의 기능

| 핀 이름 | 핀 번호  | 기능 |
| --- | --- | --- |
| PEN(nPEN) | 1 | 프로그램 활성화 핀
SPI 프로그래밍 모드에 사용됨
시스템이 리셋될 때, nPEN이 ‘0’이면 SPI모드로 진입 |
| VCC | 21, 51 | 디지털 공급 전원 - 2쌍의 VCC, GND를 사용해 프로세서의 전원 공급 |
| GND | 22, 53
63 | 공급 전원 접지 - 2쌍의 VCC, GND를 사용해 프로세서의 전원 공급 |
| AVCC | 64 | A/D 컨버터(ADC용 아날로그) 전원 전압
- ADC를 사용하지 않을 때, VCC로 연결
- ADC를 사용할 때, 저역 통과 필터(low-pass filter)를 통해 VCC에 연결 |
| AREF | 62 | A/D 컨버터 기준 전압 |
| ALE | 43 | Address Latch Enable, 포트 A에서 하위 어드레스 버스가 출력될 때
ALE핀에서 ‘H’가 출력 |
| WR(nWR) | 33 | Write, 외부 메모리에 데이터를 라이트할 때 ‘L’가 출력 |
| RD(nRD) | 34 | Read, 외부 메모리에서 데이터를 리드할 때 ‘L’가 출력 |
| RESET | 20 | 시스템 리셋 신호 입력
최소 펄스 폭 : 50ns |
| XTAL1 | 24 | 내부 발진회로(오실레이터) 입력 |
| XTAL2 | 23 | 내부 발진회로(오실레이터) 출력 |

### 양방향 범용 입출력 핀의 기능

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| PA7~PA0 | 44~51 | 포트 A
[대체 용도] 외부 메모리를 연결할 때, 하위 어드레스 및 데이터(AD0~AD7) 핀으로 사용 |
| PB7~PB0 | 10~17 | 포트 B
[대체 용도] SPI, PWM  핀으로 사용 |
| PC7~PC0 | 35~42 | 포트 C
[대체 용도] 외부 메모리를 연결할 때, 하위 어드레스 및 데이터( A8~A15) 핀으로 사용 |
| PD7~PD0 | 25~32 | 포트 D
[대체 용도]
- 타이머, USART, TWI 입출력 신호로 사용
- 외부 인터럽트 요청 핀(INT0~INT4) |
| PE7~PE0 | 2~9 | 포트 E
[대체 용도]
- 타이머, USART, TWI 입출력 신호로 사용
- 외부 인터럽트 요청 핀(INT5~INT7) |
| PF7~PF0 | 54~61 | 포트 F
[대체 용도]
ADC 입출력 신호로 사용 |
| PG4~PG0 | 18, 19, 33, 34, 43 | 포트 G
[대체 용도]
- 외부 메모리 인터페이스 신호(nRD, nWR, nALE)로 사용
- 타이머 신호(TOSC2, TOSC1)로 사용 |

### 외부 메모리 인터페이스 핀의 기능

- 프로세서 외부에 추가적으로 메모리를 연결할 경우 사용

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| AD7~AD0 | 44~51 | 어드레스의 하위 바이트 및 데이터 버스 핀 |
| A15~A8 | 35~42 | 어드레스 상위 바이트 핀 |
| ALE | 43 | 어드레스가 출력되었음을 통지하는 출력 핀 |
| nRD | 34 | 외부 메모리 읽기 신호 출력 핀 |
| nWR | 33 | 외부 메모리 쓰기 신호 출력 핀 |

### 외부 인터럽트 요청 핀의 기능

- 프로세서 외부에 연결된 주변장치에서 인터럽트 요청할 때 사용
- 8개의 인터럽트 지원

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| INT3~INT0 | 25~28 | 외부 인터럽트 0~3번 입력 핀 |
| INT7~INT4 | 6~9 | 외부 인터럽트 4~7번 입력 핀 |

### USART 인터페이스 핀의 기능

- 2개의 시리얼 포트용 입출력 핀

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| TXD0(송신), RXD0(수신) | 3, 2 | 0-번 시리얼 포트의 송수신 핀 |
| TXD1(송신), RXD1(수신) | 28, 27 | 1-번 시리얼 포트의 송수신 핀 |
| XCK0, XCK1 | 4, 30 | 동기식 전송모드에서 사용하는 클럭 입력 핀 |

### SPI 인터럽트 요청 핀의 기능

- 동기식 시리얼 인터페이스용 입출력 핀

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| nSS | 10 | SPI 슬레이브 선택 핀 |
| SCK | 11 | SPI 시리얼 클럭 핀 |
| MOSI | 12 | SPI 마스터 출력/슬레이브 입력 핀 |
| MISO | 13 | SPI 마스터 입력/슬레이브 출력 핀 |

### TWI 인터페이스 핀의 기능

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| SCL | 25 | 시리얼 클럭 핀 |
| SDA | 26 | 시리얼 데이터 핀 |

### ISP 인터페이스의 핀 기능

- 플래시 프로그래밍용 입출력 핀

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| SCK | 11 | 시리얼 클럭 핀 |
| PDI | 2 | 프로그래밍 데이터 입력 핀 |
| PDO | 3 | 프로그래밍 데이터 출력 핀 |

### RTC 발진자 핀의 기능

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| TOSC1, TOSC2 | 19, 18 | RTC 발진자 연결 핀 |

### ADC 입력 신호 핀의 기능

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| ADC7~ADC0 | 54~61 | 8개 ADC 채널의 입력 신호 핀 |

### 아날로그 비교기 입력 핀의 기능

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| AIN0, AIN1 | 4, 5 | 아날로그 비교기의 +/- 입력 핀 |

### 타이머 클럭 핀의 기능

- 타이머가 외부 클럭을 사용할 때, 클럭을 입력하는 핀

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| T1, T2, T3 | 31, 32, 8 | 타이머 외부 클럭 입력 핀 |

### 타이머의 PWM 출력 핀의 기능

- 타이머를 사용해 펄스 폭 변조(PWM) 신호를 출력하는 핀

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| OC0 | 14 | 타이머 0의 PWM 신호 출력 핀 |
| OC1A, OC1B, OC1C | 15~17 | 타이머 1의 PWM 신호 출력 핀 |
| OC2 | 17 | 타이머 2의 PWM 신호 출력 핀 |
| OC3A, OC3B, OC3C | 5~7 | 타이머 3의 PWM 신호 출력 핀 |

### 타이머 캡처 트리거 핀의 기능

- 타이머 값을 읽어서 저장 시작을 지시하는 핀

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| IC1, IC3 | 29, 9 | 타이머-1, 3에서 사용되는 캐처 시작 신호 핀 |

### JTAG 인터페이스 신호 핀의 기능

- ISP, 디버깅, 테스트에 사용되는 핀

| 핀 이름 | 핀 번호 | 기능 |
| --- | --- | --- |
| TCK | 57 | 테스트 클럭 입력 핀 |
| TMS | 56 | 테스트 모드 선택 신호 핀 |
| TDO | 55 | 테스트 데이터 출력 핀 |
| TDI | 54 | 테스트 데이터 입력 핀 |
