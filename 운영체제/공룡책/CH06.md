# CH06 Synchronization Tools

프로세스는 협력을 하기 때문에 서로에게 영향을 끼친다. shared memory나 message passing을 이용해 같은 메모리에 접근하기도 한다. concurrent하게 접근할 경우 data integrity가 깨질 수가 있다. 

데이터 무결성을 유지하기 위한 방법에 대해 알아보자.

### Background

concurrent하거나 parallel한 실행은 어떻게 데이터 무결성을 깨뜨릴까?

주된 이유는 모든 실행이 비동기적으로 이뤄지는 것과 데이터가 공유된다는 점이다.

무질서하게 interleaved하게 프로세스가 producer, consumer가 번갈아 실행될 경우, 중간중간 context switch가 발생하고, 실행 순서에 결과가 의존적이게 된다. 

몇몇 프로세스가 같은 데이터에 concurrent하게 접근하고 결과가 프로세스 실행 순서에 따라 영향을 받는 이런 상황을 race condition이라고 한다.

이를 해결하기 위해서는 synchronized한 방법이 필요하다.

예를 들어, 다른 core에서 parallel하게 실행된다는가 등

### The Critical-Section Problem(임계 영역 문제)

n개의 프로세스가 있고, 같은 데이터에 조회하거나 변경하려고 한다고 해보자.

중요한 점은 한 프로세스가 critical section에 있을 때 다른 프로세스가 실행되지 않아야 한다는 점이다.

3개의 section이 있다.

- entry section
- exit section
- remainder section

임계 영역 문제에서 꼭 해결해야 하는 문제 3가지가 있다.(하지만 현실에선 3가지 모두를 해결하는 해결책이 없어 일부만 해결하는 방법을 쓴다.)

1. Mutual Exclusion - 상호 배제, 3개 중에 제일 해결되어야 하는 부분
2. Progress - deadlock을 피해야 한다.(무기한으로 프로세스 실행이 지연되는 경우)
3. Bounded waiting - starvation를 피해야 한다.(한 프로세스가 계속 실행되지 않는 경우)

싱글 코어 환경에서는 공유 변수가 변경되는 시점에 interrupt를 방지해 임계 영역 문제를 해결할 수 있다.

하지만 현실은 멀티 코어 환경이기 때문에 이는 해결책이 되지 못한다.

2가지 접근 방식을 생각해볼 수 있다.

1. preemptive kernels(다른 프로세스가 접근하지 못하게 함)
    1. 상호 배제는 확실하게 되지만 속도가 느려서 쓰지 않음
2. non-preemptive kernels(다른 프로세스에게 cpu를 넘길 수 있음)
    1. 위험이 있긴 하나 더 responsive해서 이걸 사용한다.

### Peterson’s Solution

클래식한 소프트웨어 기반 해결책이다.(하지만 실제 이 해결책 그대로 코드를 돌려도 결과가 보장되지 않는데 말 그대로 “software” 기반 해결책이이 때문이다. hardware의 발전이 눈부셔 속도가 매우 빠르기 때문에 이 해결책으로는 Synchronization 문제를 해결할 수 없다.)

그래도 알고리즘 방식으로 훌륭해 공부하라고 한다.

피터슨의 해결책은 두 개의 프로세스를 임계 영역과 remainder 영역 사이를 전환하도록 제한한다.(한 쪽으로 왔다갔다 하게 함)

flag와 turn 변수를 이용해서 flag가 true, turn이 j인 프로세스가 임계 영역에 진입하고 해당 프로세스가 끝나면 flag를 false로 바꿔 remainder 영역의 프로세스에게 cpu 권한을 넘긴다. 

이론적으로

1. 상호 배제를 해결할 수 있고
2. deadlock 상황도 발생하지 않으며
3. starvation 도 발생하지 않는다.

(현실은 그렇지 못하다.)

Peterson’s Solution 

producer 측면, consumer 측면

<img width="1237" alt="image" src="https://user-images.githubusercontent.com/84627144/167834077-2409e57c-e750-4ceb-9d00-6eaf225bd760.png">

### Hardware Support for Synchronization

hardware instruction를 이해해야 피터슨의 해결책이 왜 결과가 저따구로 나오는지 이해할 수 있다.

이 부분 다시 공부해야 겠다 멘탈 갈렸어,,